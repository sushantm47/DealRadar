{% extends "base.html" %}
{% block content %}

<div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; text-align:center; padding-top:20%;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-4 fw-bold text-dark">Scanning Amazon...</h4>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h2 class="fw-bold mb-1">Dashboard</h2>
                <p class="text-muted mb-0">Manage your tracked items.</p>
            </div>
            <a href="{{ url_for('trigger_scrape') }}" class="btn btn-warning shadow-sm" onclick="showLoading()">
                <i class="fas fa-sync-alt me-1"></i> Check Prices
            </a>
        </div>

        {% if active_deals %}
        <div class="card mb-4 border-success border-2 shadow-sm">
            <div class="card-header bg-success text-white">
                <i class="fas fa-bolt me-2"></i> <strong>Active Deals!</strong> (Price < Target)
            </div>
            <div class="list-group list-group-flush">
                {% for item in active_deals %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold text-success">{{ item.pname[:50] }}...</div>
                        <small class="text-muted">Target: ${{ item.cutoff }}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-success fs-6">${{ item.current_price }}</span>
                        <a href="{{ item.tracking_url }}" target="_blank" class="btn btn-sm btn-outline-success ms-2">Buy â†—</a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="card mb-5">
            <div class="card-header bg-white"><i class="fas fa-eye me-2 text-primary"></i> Watching</div>
            <div class="table-responsive">
                <table class="table mb-0 align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40%;">Product</th>
                            <th style="width: 20%;">Price</th>
                            <th style="width: 25%;">Target</th>
                            <th style="width: 15%; text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in watchlist %}
                        <tr>
                            <td>
                                <div class="fw-bold text-dark mb-1">{{ item.pname[:40] }}...</div>
                                <span class="badge bg-light text-secondary border">{{ item.p_category }}</span>
                            </td>
                            <td>
                                {% if item.current_price > 0 %}
                                    <span class="fs-5 fw-bold text-dark">${{ item.current_price }}</span>
                                {% else %}
                                    <span class="text-muted small">Pending...</span>
                                {% endif %}
                            </td>
                            <td>
                                <form action="{{ url_for('update_target') }}" method="POST" class="d-flex">
                                    <input type="hidden" name="cid" value="{{ item.cid }}">
                                    <input type="number" name="new_cutoff" step="0.01" class="form-control form-control-sm me-1" 
                                           value="{{ item.cutoff if item.cutoff > 0 else '' }}" placeholder="Set Alert">
                                    <button type="submit" class="btn btn-outline-secondary btn-sm"><i class="fas fa-check"></i></button>
                                </form>
                            </td>
                            <td class="text-end">
                                <button type="button" class="btn btn-light btn-sm text-primary" data-bs-toggle="modal" data-bs-target="#detailsModal{{ item.cid }}">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <a href="{{ url_for('delete_cart', cid=item.cid) }}" class="btn btn-light btn-sm text-danger"><i class="fas fa-trash"></i></a>
                            </td>
                        </tr>

                        <div class="modal fade" id="detailsModal{{ item.cid }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Product Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h6><strong>Full Name:</strong></h6>
                                        <p>{{ item.pname }}</p>
                                        <hr>
                                        <h6><strong>Tracking URL:</strong></h6>
                                        <p class="small text-muted text-break">{{ item.tracking_url }}</p>
                                        <hr>
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">Last Checked</small><br>
                                                <strong>{{ item.last_checked }}</strong>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-muted">Database ID</small><br>
                                                <strong>#{{ item.pid }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="{{ item.tracking_url }}" target="_blank" class="btn btn-primary w-100">View on Amazon</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <tr><td colspan="4" class="text-center p-5 text-muted">Watchlist is empty.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <h5 class="text-muted mb-3">Logs</h5>
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">ðŸ“œ Notification History</a>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for alert in history_alerts %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">{{ alert.createdat }}</small><br>
                            <strong>{{ alert.pname[:40] }}...</strong> dropped to <span class="text-success fw-bold">${{ alert.price }}</span>
                        </div>
                        <span class="badge bg-light text-dark">History</span>
                    </li>
                    {% else %}
                    <li class="list-group-item text-center text-muted p-4">No history yet.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>

    </div>

    <div class="col-lg-4">
        <div class="card shadow border-primary mb-3">
            <div class="card-header bg-primary text-white"><strong>+ Add Amazon Item</strong></div>
            <div class="card-body bg-light">
                <form action="{{ url_for('user_create_product') }}" method="POST" onsubmit="showLoading()">
                    <div class="mb-3">
                        <input type="text" name="pname_or_link" class="form-control" placeholder="Paste Amazon URL..." required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Fetch & Track</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function showLoading() { document.getElementById('loadingOverlay').style.display = 'block'; }
</script>
{% endblock %}